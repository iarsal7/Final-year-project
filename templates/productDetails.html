{% extends 'base.html' %}

{% block content %}

<div class="row">

<div class="col-12 col-md-6">

<div class="card" style="width: 18rem;">
  <div class="card-body">
   <img class="card-img-top" src="{{ product.image.url}}" alt="Card image cap" width=""auto" height="250px">
    <h5 class="card-title">{{product.title}}</h5>
    <p class="card-text">{{product.description}}</p>
  </div>
</div>
</div><!--col end-->

{% if request.user.is_authenticated %}
  <div class="col-12 col-md-6">
    <form method="POST" action='{% url 'cart' %}' class="form form-product-ajax"> {% csrf_token %}
      <input type="hidden"  name="product_id" value="{{product.id}}" >
     <button class="btn btn-success" name="submit" type="submit" value="submit">Add to cart</button>
         <div class="mt-5 col-6 mr-auto">
           <input type="number" value="1" min="1" max="100" step="1" name="quantity"/>
          </div>

    </div>
    </form>

  </div>
   {% else %}

    <div class="col-12 col-md-6">
    
     <button class="btn btn-success " data-toggle="modal" data-target="#loginModal">Add to cart</button>
    </div>

  </div>
{% endif %}

</div><!--row end-->

<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-title text-center">
          <h4>Login</h4>
        </div>
        <div class="d-flex flex-column text-center">
          <form method="POST" id="loginUser" >{% csrf_token %}
            <div class="form-group">
              <input type="text" class="form-control"  placeholder="Your username..." name="modal-user">
            </div>
            <div class="form-group">
              <input type="password" class="form-control"  placeholder="Your password..." name="modal-password">
            </div>
            <button type="submit" class="btn btn-info btn-block btn-round">Login</button>
          </form>
          
         
      <div class="modal-footer d-flex justify-content-center">
        <div class="signup-section">Not a member yet? <a href="#a" class="text-info"> Sign Up</a>.</div>
      </div>
  </div>
</div>
{% endblock content %}

{% block javascript %}

<script>

    $(document).ready(function(){
        var productForm = $(".form-product-ajax") //add to cart
        productForm.submit(function(event){
        event.preventDefault();
        var thisForm = $(this)
        var action= thisForm.attr("action");
        var method = thisForm.attr("method");
        var formData = thisForm.serialize();

        
      $.ajax({
        url: action,
        method: method,
        data: formData,
        success: function(data){
         
        var cartcount= $(".cart-count") //cart-count is span field in base.html
        cartcount.text(data.cartCount) //cartCount is jsonResponse in views
        },

      error: function(errorData){
        console.log("error")
        console.log(errorData)
      }
      })

        })
      })  {% comment %} add to cart ending {% endcomment %}

$("form#loginUser").submit(function(event) {
  
    event.preventDefault();
    console.log("in modal form")
    var modeluser = $('input[name="modal-user"]').val().trim();
    var modelpassword = $('input[name="modal-password"]').val().trim();

     if (modeluser && modelpassword) {
        $.ajax({
            url: '{% url 'cartLogin' %}',
            data: {
                'username': modeluser,
                'password': modelpassword,
            },
            dataType: 'json',
            success: function (data) {
              if (data.status=='ok') {
                   
              $('form#updateUser').trigger("reset");
              $('#loginModal').modal('hide');
              

                }

              else{

                 alert("Username or password incorrect");
                 $('form#updateUser').trigger("reset");
                 return false;

              }  
              }
            
             
        });

    }
     else {
        alert("All fields must have a valid value.");
        return false;
    }

   
});


</script>


{% endblock javascript %}